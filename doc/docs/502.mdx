---
id: 502
title: 脚本常见问题
---

import useBaseUrl from "@docusaurus/useBaseUrl";
import Tag from "@site/src/components/Tag.js";
import Highlight from '@site/src/components/Highlight.js';

:::tip `提示`

通过自定义脚本，可快速适配业务模型，比如各大云平台的Iot物模型

欢迎大家投稿平台适配案例

:::

## 一、脚本示例

```

//变量脚本动态设置传输实体的Demo
//只传输变量名称，变量值，变量在线状态，变量值改变时间
    public class DemoScript:IDynamicModel
    {
        public IEnumerable<dynamic> GetList(IEnumerable<object> datas)
        {
            List<DemoData> demoDatas = new List<DemoData>();
            foreach (var v in datas)
            {
                var data=(VariableData)v;
                DemoData demoData = new DemoData();
                demoData.Value = data.Value;
                demoData.Name = data.Name;
                demoData.IsOnline = data.IsOnline;
                demoData.ChangeTime = data.ChangeTime;
                demoDatas.Add(demoData);
            }
            return demoDatas;
        }
    }
    public class DemoData
    {
        public string Name { get; set; }
        public bool IsOnline { get; set; }
        public object Value { get; set; }
        public DateTime ChangeTime { get; set; }
    }

```


## 二、适配 ThingsBoard 脚本


对应文档：[ThingsBoard](https://thingsboard.io/docs/reference/gateway-mqtt-api/)



### 设备属性脚本

```
using TouchSocket.Core;
public class ThingsBoardDeviceScript : IDynamicModel
{
    public IEnumerable<dynamic> GetList(IEnumerable<object> datas)
    {
        Dictionary<string, Dictionary<string, object>>
dict = new Dictionary<string, Dictionary<string, object>>
();
        foreach (var v in datas)
        {
            var data = (DeviceBasicData)v;
            Dictionary<string, object> demoData = new Dictionary<string, object>
            {
                { nameof(Device.Description), data.Description },
                { nameof(DeviceBasicData.ActiveTime), data.ActiveTime },
                { nameof(DeviceBasicData.DeviceStatus), data.DeviceStatus.ToString() },
                { nameof(DeviceBasicData.LastErrorMessage), data.LastErrorMessage },
                { nameof(DeviceBasicData.PluginName), data.PluginName },
                { nameof(DeviceBasicData.Remark1), data.Remark1 },
                { nameof(DeviceBasicData.Remark2), data.Remark2 },
                { nameof(DeviceBasicData.Remark3), data.Remark3 },
                { nameof(DeviceBasicData.Remark4), data.Remark4 },
                { nameof(DeviceBasicData.Remark5), data.Remark5 }
            };

            dict.AddOrUpdate(data.Name, demoData);
        }
        return new List<dynamic>() { dict };
    }
}


```


### 变量脚本
```

using ThingsGateway.Foundation;

using TouchSocket.Core;

public class ThingsBoardVariableScript : IDynamicModel
{
    public IEnumerable<dynamic> GetList(IEnumerable<object> datas)
    {
        var dict = new Dictionary<string, List<ThingsBoardValue>>();
        // 对输入列表进行分组，根据 DeviceName 属性分组
        var groups = datas.Where(a => !string.IsNullOrEmpty(((VariableData)a).DeviceName)).GroupBy(a => ((VariableData)a).DeviceName, a => ((VariableData)a));
        // 遍历每一个分组
        foreach (var group in groups)
        {
            var data = group.GroupBy(a => a.CollectTime);
            List<ThingsBoardValue> thingsBoardValues = new();
            foreach (var item in data)
            {
                ThingsBoardValue thingsBoardValue = new();
                thingsBoardValue.ts = item.Key.DateTimeToUnixTimestamp();
                foreach (var tag in item)
                {
                    thingsBoardValue.values.AddOrUpdate(tag.Name, tag.Value);
                }
                thingsBoardValues.Add(thingsBoardValue);
            }

            dict.AddOrUpdate(group.Key, thingsBoardValues);

        }
        return new List<dynamic>() { dict };
    }
}

public class ThingsBoardValue
{
    public long ts { get; set; }
    public Dictionary<string, object> values { get; set; } = new();
}


```
### 传输主题

变量Topic 填入 `v1/gateway/telemetry`

设备Topic 填入 `v1/gateway/attributes`

RpcTopic 天然 `v1/gateway/rpc`

变量列表上传 填入 false

设备状态列表上传 填入 false


## 三、适配阿里云物模型脚本


对应文档：[阿里云设备属性上报](https://help.aliyun.com/zh/iot/user-guide/data-formats?spm=a2c4g.11186623.0.i17#section-jrb-lrl-b2b)



### 变量脚本
```

//一个适配阿里云IOT的变量脚本demo


public class AliYunIotScript:IDynamicModel
{
   public IEnumerable<dynamic> GetList(IEnumerable<object> datas)
    {
        List<AliYunIot> aliYunIots = new();
        // 对输入列表进行分组，根据 Remark1属性分组
        var groups = datas.Where(a => !string.IsNullOrEmpty(((VariableData)a).Remark1)).GroupBy(a => ((VariableData)a).Remark1,a=> ((VariableData)a));
        // 遍历每一个分组
        foreach (var item in groups)
        {
            var requestId = Yitter.IdGenerator.YitIdHelper.NextId();
            var iotId = item.Key; //Remark1自定义为设备Id
            var productKey = item.FirstOrDefault(a => !string.IsNullOrEmpty(a.Remark2))?.Remark2;//Remark2自定义为产品Id
            var deviceName = item.FirstOrDefault(a => !string.IsNullOrEmpty(a.Remark3))?.Remark3;//Remark3自定义为设备名称
            AliYunIot aliYunIot = new();
            aliYunIot.iotId = iotId;
            aliYunIot.requestId = requestId.ToString();
            aliYunIot.deviceName = deviceName;
            aliYunIot.productKey = productKey;
            // 遍历分组内的每一个元素
            foreach (var varItem in item)
            {

                    // 设置采集时间，并转换为 Unix 时间戳
                    // 设置值
                    var data = new Property() { value = varItem.Value, time = new DateTimeOffset(varItem.CollectTime).ToUnixTimeSeconds() };
                    // 以 变量名称 作为键，将新对象添加到分组的 属性 中
                    aliYunIot.items.Add(varItem.Name, data);
 
            }
            aliYunIots.Add(aliYunIot);
        }
        return aliYunIots;
    }

   
}
 public class AliYunIot
    {
        public string iotId { get; set; }
        public string requestId { get; set; }
        public string productKey { get; set; }
        public string deviceName { get; set; }
        public Dictionary<string, Property> items { get; set; } = new();
    }

    public class Property
    {
        public object value { get; set; }
        public long time { get; set; }
    }



```


### 传输主题

变量Topic 填入 `/${productKey}/${deviceName}/thing/event/property/post`
