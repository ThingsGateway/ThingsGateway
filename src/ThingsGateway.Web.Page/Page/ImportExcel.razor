@*
//------------------------------------------------------------------------------
//  此代码版权声明为全文件覆盖，如有原作者特别声明，会在下方手动补充
//  此代码版权（除特别声明外的代码）归作者本人Diego所有
//  源代码使用协议遵循本仓库的开源协议及附加协议
//  Gitee源代码仓库：https://gitee.com/diego2098/ThingsGateway
//  Github源代码仓库：https://github.com/kimdiego2098/ThingsGateway
//  使用文档：https://diego2098.gitee.io/thingsgateway-docs/
//  QQ群：605534569
//------------------------------------------------------------------------------
*@

@namespace ThingsGateway.Web.Page
@using System.Linq.Expressions;
@using BlazorComponent;
@using Furion.DataValidation;
@using Mapster;
@using Masa.Blazor.Presets;
@using System.IO;
@using TouchSocket.Core;
@inject MasaBlazor MasaBlazor
@inherits CultureComponentBase
@inject UserResoures UserResoures

<PModal @bind-Value="IsShowImport" OnCancel="() => IsShowImport = false"
        Title=@T("导入") Persistent
        MaxWidth="1000">
    @if (IsShowImport)
    {
        <MStepper NonLinear Value="Step">
            <MStepperHeader>
                <MStepperStep Editable Step="1" Complete="Step==2" OnClick="()=>{Step=1;_importFile=null;}">
                    @T("导入表格")
                </MStepperStep>
                <MDivider></MDivider>
                <MStepperStep Step="2">
                    @T("验证结果")
                </MStepperStep>
                <MDivider></MDivider>
                <MStepperStep Step="3">
                    @T("确认导入")
                </MStepperStep>
            </MStepperHeader>

            <MStepperItems>
                <MStepperContent Step="1">
                    <MFileInput @bind-Value="_importFile" FullWidth ShowSize></MFileInput>

                    <MLabel Class="my-3 green--text">@T("数据量较大时(大于1万)，所需导入时间可能超过1分钟，请耐心等待") </MLabel>

                    <div class="mt-6">
                        <MButton Color="primary" Loading=@isImport OnClick="()=>DeviceImport(_importFile)">@T("下一步")</MButton>
                    </div>

                </MStepperContent>
                <MStepperContent Step="2">
                    <div style="overflow-y:auto">

                        @foreach (var item in ImportPreviews)
                        {
                            <MSubheader Class="mt-2 font-weight-black"> @($"{item.Key}，预计导入{item.Value.DataCount}条数据")  </MSubheader>
                            <MSubheader Class=@((item.Value.HasError?"mt-2 red--text":"mt-2 green--text"))> @((item.Value.HasError ? "出现错误" : "验证成功"))  </MSubheader>

                            <MVirtualScroll Context="item1" Height=300 OverscanCount=2 ItemSize="60" Items="item.Value.Results">
                                <ItemContent>
                                    <MListItem>
                                        <MListItemAction>
                                            <MChip Class="ma-2">
                                                @($"第{item1.row}行")
                                            </MChip>
                                        </MListItemAction>

                                        <MListItemContent>
                                            <MListItemTitle Class=@((item1.isSuccess?"green--text":"red--text"))>
                                                <strong>@item1.resultString</strong>
                                            </MListItemTitle>
                                        </MListItemContent>

                                    </MListItem>

                                    <MDivider></MDivider>

                                </ItemContent>
                            </MVirtualScroll>

                        }
                    </div>
                    <div class="mt-6">
                        <MButton Color="primary" Disabled=@ImportPreviews.Any(it=>it.Value.HasError) OnClick="()=>Step=3">@T("下一步")</MButton>
                    </div>


                </MStepperContent>
                <MStepperContent Step="3">

                    <MLabel Class="my-3 green--text">@T("数据量较大时(大于1万)，所需导入时间可能超过1分钟，请耐心等待") </MLabel>

                    <div class="mt-6">
                        <MButton Color="primary" Loading=@isSaveImport OnClick="SaveDeviceImport">@T("上传")</MButton>
                    </div>

                </MStepperContent>
            </MStepperItems>
        </MStepper>
    }

</PModal>




